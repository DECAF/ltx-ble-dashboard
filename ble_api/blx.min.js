const blx=(()=>{"use strict";const e="V0.63 / 07.12.2020";function t(e=1){return new Promise(t=>setTimeout(t,e))}const a=3988292384;function n(e){let t=4294967295;for(let n=0;n<e.length;n++){t^=e[n],t>>>=0;for(let e=0;e<8;e++)1&t?t=t>>>1^a:t>>>=1}return t>>>0}let i,r=[],o=!1;const s="5c170001-b5a3-f393-e0a9-a37f42997c22",c="5c170002-b5a3-f393-e0a9-a37f42997c22",l="5c170003-b5a3-f393-e0a9-a37f42997c22";let d,f,u,R,b=!1,m=!1,v=!1,p=0,w="?",g={total:0,incnew:0,max:-1,mode:0};const y=3,k=16,h=17,S=32,O=33,E=34,C=35,x=1e4;let I,A,D,T,_,F,N,B,M,L,P,U,K="unknown.dat";const G=20;let V,z,W,H=!1,X=!1,q="3";function j(){f=void 0,u=void 0,b=!1,o=!1,m=!1,!0===v?(me("Disconnected while Busy('"+w+"')"),p="ERROR: Disconnected ('"+w+"')"):me("Disconnected"),v=!1,i&&(void 0!==d?i("CON",1,"Reconnectable"):i("CON",0,"Disconnected"))}function Y(e){const t=new Uint8Array(e.target.value.buffer),a=t.length;if(a<2)return me("ERROR(Data): NUS RX blocklen: "+a),void console.log(t);const n=t[0];if(n+2!==a)return me("ERROR(Data): NUS RX blocklen/dlen(0): "+a+"/"+n),void console.log(t);const s=t[1],c=t.subarray(2);let l,d,f,u;switch(s){case C:if(Ie(),"~"===(l=(new TextDecoder).decode(c)).charAt(0)&&l.length>1)switch(l.charAt(1)){case"G":d=parseInt(l.substr(3)),me((f=parseInt(l.substr(l.indexOf(" "))))?"Get "+d+" Bytes from Position "+f:"Get "+d+" Bytes"),N=d,M=0,B=new Uint8Array(d),L=Date.now(),P=L-1e3;break;case"D":d=parseInt(l.substr(l.indexOf("DS:")+3)),f=parseInt(l.substr(l.indexOf("DA:")+3)),u=new Date(1e3*parseInt(l.substr(l.indexOf("DF:")+3))),me("Disksize: "+(d/1024).toFixed(0)+" kB / Available: "+(f/1024).toFixed(0)+" kB Formated: ["+u.toLocaleDateString()+" "+u.toLocaleTimeString()+"]"),r.disk=[],r.disk.diskSize=d,r.disk.available=f,r.disk.formated=u,r.disk.files=[],o=!0;break;case'"':{d=l.lastIndexOf('"');const e=l.substring(2,d),t=l.substr(d);d=parseInt(t.substr(t.indexOf("L:")+2)),f=parseInt(t.substr(t.indexOf("CR:")+3),16),u=new Date(1e3*parseInt(t.substr(t.indexOf("T:")+2)));const a=t.indexOf("UC "),n=t.indexOf("ES ");let i="";a>0&&(i=" (Unclosed)"),isNaN(f)||(i+=" CRC: "+f.toString(16).toUpperCase()),n>0&&(i+=" ExtSync"),me(' - "'+e+'" Len: '+d+" Bytes"+i+" ["+u.toLocaleDateString()+" "+u.toLocaleTimeString()+"]");const s=[];s.fname=e,s.len=d,s.crc32=f,s.date=u,s.ucl_flag=Boolean(a>0),s.esync_flag=Boolean(n>0),r.disk.files.push(s),o=!0}break;case"X":X?(me("Keep Connection Ping..."),Z("")):(me("WARNING: Connection Auto-Disconnect soon"),i&&i("WARN",1,"Connection Auto-Disconnect soon"));break;case"e":{d=parseInt(l.substr(3));const e=l.substr(l.indexOf(" ")+1);f=parseInt(e),e.indexOf(" ")>0?me("Measure ("+d+" Channels in "+f+" msec) Modemstate: "+(u=parseInt(e.substr(e.indexOf(" ")+1)))):me("Measure ("+d+" Channels in "+f+" msec)"),i&&(i("MEAS_CH",d,"Channels"),i("MEAS_T",f,"msec"))}break;case"H":case"#":{const e=parseInt(l.substr(2)),t=l.substr(l.indexOf(" ")+1);me("("+e+")"+t),i&&i("MEAS_V",e,t)}break;case"h":me("Alarmbits: "+(d=parseInt(l.substr(3))));break;case"M":{d=parseInt(l.substr(2));const e=l.substr(l.indexOf(" ")+1);me("Motion("+d+" Cnt), Measure in "+(f=parseInt(e))+" secs"),xe&&(Ae(100,.3,.2),Ae(99,.3,.2))}break;default:me("ERROR((~more)): '"+l+"' ???")}else{const e=l.replace("\n","").replace("\r","");i&&i("MSG",0,e),me("(more): '"+e+"'")}break;case O:if(Ie(),"~"===(l=(new TextDecoder).decode(c)).charAt(0)&&l.length>1)switch(l.charAt(1)){case"B":o=!0,r.deviceMAC="(UNKNOWN)",(u=l.indexOf(" "))>0?16===(f=l.substr(u+1)).length?(me("Device MAC:"+f),r.deviceMAC=f):p="ERROR: Invalid MAC":p="ERROR: No MAC",(d=parseInt(l.substr(3)))>=G&&d<250?me("BLE Blocksize: "+(V=d)+" Bytes"):p="ERROR: BLE Blocksize: "+d;break;case"C":d=parseInt(l.substr(3)),W=d,(u=l.indexOf(" "))>0?(f=parseInt(l.substr(u+1)))>0?p="ERROR: Connection Speed: ("+d+"): "+f:me("Connection Speed: "+(d>50?"Standard (":"Fast (")+d+")"):p="ERROR: Connection Speed";break;case"T":{d=parseInt(l.substr(3));const e=new Date(1e3*d);let t,a=(Date.now()/1e3-d).toFixed(0);a>864e3||a<-864e3?t=" (Warning: DeviceTime Lost!)":(a<=1&&a>=-1&&(a=0),t=" (Delta to App: "+a+" sec)"),r.deltaToApp=a,me("Time: ["+e.toLocaleDateString()+" "+e.toLocaleTimeString()+"] "+t)}break;case"V":{d=parseInt(l.substr(3));const e=l.substr(l.indexOf(" ")+1);f=parseInt(e),u=new Date(1e3*parseInt(e.substr(e.indexOf(" ")+1))),r.deviceType=d,r.firmwareVersion=(f/10).toFixed(1),r.firmwareBuilt=u.toUTCString(),r.cpu=-1," "===e.substr(-3,1)&&(r.cpu=parseInt(e.substr(-2))),me("DeviceType: "+d+" V"+r.firmwareVersion+" (Built: "+r.firmwareBuilt+") CPU:"+r.cpu)}break;case"N":d=parseInt(l.substr(3)),f=new Date(1e3*parseInt(l.substr(l.indexOf(" ")+1))),me("Filesize: "+d+" Bytes"),I=d,A=f;break;case"L":me((d=parseInt(l.substr(3)))+" Bytes transferred");break;case"P":me("File Ready");break;case"I":me("Memory Ready");break;case"K":me("Memory cleared");break;default:me("ERROR(End): '"+l+"' ???")}else me("End: '"+l+"' (Runtime: "+(Date.now()-R).toFixed(0)+" msec)");v=!1;break;case S:switch((l=(new TextDecoder).decode(c)).charAt(0)){case"R":(d=parseInt(l.substr(2)))<-199&&d>=0?(z="[NoSignal]",d=-200):z=d,H&&me("Signal (dBm):"+z),Ce&&function(e){if(e>199)Ae(30,.2,.3);else{e<30&&(e=30);const t=100*Math.pow(2,(100-e)/12);Ae(t,.5,.15)}}(-d),i&&i("RSSI",d," dBm");break;default:me("Info: '"+l+"'")}break;case E:{if(d=N-M,c.length>d){p="ERROR: Too many data";break}B.set(c,M),M+=n;const e=Date.now();if(e-P>1e3&&(d=(M/N*100).toFixed(0),i&&i("PROG",d,"%"),me("Get: "+d+"% / "+M+" Bytes"),P=e),0===(d=N-M)){let e=Date.now()-L;e||e++;const t=(M/e*1e3).toFixed(0);me("Get OK ("+e/1e3+" sec, "+t+" Bytes/sec)"),i&&i("GET_OK",t,"Bytes/sec")}}break;default:me("ERROR(Data): '"+l+"'")}}async function J(e,t,a=y){if(void 0!==d&&null!==d.name){for(e&&((r=[]).advertisingName=d.name,o=!0),i&&i("CON",2,"Connecting...");;){try{me(e?"Connect to '"+d.name+"'...":"Reconnect to '"+d.name+"'..."),a--;const t=await d.gatt.connect(),n=await t.getPrimaryService(s);f=await n.getCharacteristic(c),u=await n.getCharacteristic(l),await u.startNotifications(),u.addEventListener("characteristicvaluechanged",Y),me("Connected"),b=!0,i&&i("CON",3,"Connected, Identify..."),a=0}catch(e){me("RETRY(Connect, Reason: '"+e.message.substr(0,40)+"...')"),p="ERROR(Connect): '"+e.message+"'"}if(!a)break;i&&i("WARN",5,"Retry to connect ("+(a+1)+" left)..."),me("Failed, Retry("+(a+1)+" left)...")}b&&(t&&await se(!1),await ae(),function(e,t=.3,a=.05){xe&&(Ae(e,t,a),Ae(1.259*e,t,a),Ae(1.498*e,t,a))}(300))}else p="ERROR(Connect): Unknown Device Name"}async function Q(){if(o){o=!1;const e=r.deviceMAC+"_#BlxIDs";try{await blStore.set(e,r)}catch(e){p="ERROR(CheckIDs): "+e}}}async function Z(e,a=x){if(!0!==v){if(!0!==b){if(void 0===d)return void(p="ERROR(DeviceCmd): Not Connected!");if(await J(0,1),p)return}v=!0,w=e,R=Date.now(),await async function(e,t=k){const a=e.length,n=new Uint8Array(a+2),i=n.subarray(2);if(n[0]=a,n[1]=t,void 0!==(new TextEncoder).encodeInto(e,i))try{f.writeValue(n.buffer)}catch(e){let t;p="ERROR(DeviceSend): "+(t=!1===b?"Connection lost":e)}}(e),await async function(e){if(!p)for(;!0===v;)if(await t(10),(e-=10)<0){p="ERROR(DeviceCmd): Timeout ('"+w+"')";break}}(a),v=!1}else console.warn("*** BLX BUSY (Since "+(Date.now()-R).toFixed(0)+" msec) ***")}function $(e){let t=-1;for(let a=0;a<r.disk.files.length;a++)if(r.disk.files[a].fname===e){t=a;break}return t<0?(p="ERROR(Cmd): File not in Directory",-1):t}async function ee(e,t=!0){let a;if(void 0===(a=e[1])||a.length<1||a.length>21)return void(p="ERROR(Cmd): Filename");if(void 0===r.disk||void 0===r.disk.files)return void(p="ERROR(Cmd): No Disk Info");let n=$(a);if(n<0)return;if(I=-1,K=a,U=void 0,await Z("N:"+a),p)return;if(I<0)return void(p="ERROR(SysCmd): No File");if(me('Get File "'+a+'": Total Len: '+I+" Bytes"),I!==r.disk.files[n].len)return void(p="ERROR(SysCmd): File Size changed");if(r.disk.files[n].date.getTime()!==A.getTime())return void(p="ERROR(SysCmd): File Date changed");D=r.disk.files[n].crc32,T=r.disk.files[n].ucl_flag,_=r.disk.files[n].esync_flag;let o=I,s=0;e[2]&&(s=parseInt(e[2]),o=e[3]?parseInt(e[3]):I-s),s<0||o<1||s+o>I?p="ERROR(SysCmd): Out of range of File":(F=s,i&&i("GET",o,a),await le(s,o,t),p||async function(){if(void 0===M||!M)return void(p="ERROR(Store): No Data to store");if(void 0===B||B.length!==N)return void(p="ERROR(Store): Inconsistent Data");const e=r.deviceMAC+"_"+K,t=[];t.total_len=I,t.pos0=F,t.akt_len=N,t.ctime=A,t.crc32=D,t.ucl_flag=T,t.esync_flag=_,t.bytebuf=B;try{await blStore.set(e,t)}catch(e){return void(p="ERROR(Store): "+e)}me("Save to Store '"+e+"'"),B=void 0,U=e}())}async function te(e,t){let a,n,o,s;if((a=$(e))>=0){if(await blStore.get(r.deviceMAC+"_"+e),void 0===(n=blStore.result())||!0===t){if(await ee([0,e],!1),p)return}else if((o=r.disk.files[a].len-n.v.akt_len)>0){if(i&&i("GET",o,e),await async function(e,t,a){I=-1,K=void 0,U=void 0,await Z("N:"+e),p||(I<0?p="ERROR(SysCmd): No File '"+e+"'":(D=0,T=!0,_=!1,F=t,I=a,await le(t,a,!1)))}(e,n.v.akt_len,o),p)return;if(B.length!==o)return void(p="ERROR(upload): Read Len");(s=new Uint8Array(n.v.bytebuf.length+o)).set(n.v.bytebuf),s.set(B,n.v.bytebuf.length),n.v.bytebuf=s,n.v.total_len+=o,n.v.akt_len+=o;try{await blStore.set(n.k,n.v)}catch(e){p="ERROR(upload): "+e}}}else p=""}async function ae(){await t(500),await Z("CS",32e3)}async function ne(){for(let e=0;e<3;e++){if(await t(500),await Z("C"+q,32e3),p)return;if(!(W>50))return;{const e="BLE Low Speed: "+q+"->"+W;me("WARNING: "+e),i&&i("WARN",2,e)}let e;if(e=parseInt(q),isNaN(e))break;q=(++e).toString()}}async function ie(e,t=!0){const a=$(e);await blStore.get(r.deviceMAC+"_"+e);const n=blStore.result();if(a<0)return void 0!==n&&await blStore.remove(n.k),p="ERROR(identify): No File '"+e+"' on Device",void(i&&i("WARN",3,"No File '"+e+"' on Device"));if(r.disk.files[a].len<=0||!0===r.disk.files[a].ucl_flag)return p="ERROR(identify): File corrupt '"+e+"' on Device",void(i&&i("WARN",4,"File corrupt '"+e+"' on Device"));if((void 0===n||r.disk.files[a].len!==n.v.akt_len||r.disk.files[a].crc32!==n.v.crc32||r.disk.files[a].date.getTime()!==n.v.ctime.getTime())&&(await ee([0,e],t),!p)){await blStore.get(r.deviceMAC+"_"+e);const t=blStore.result();void 0!==t&&r.disk.files[a].len===t.v.akt_len&&r.disk.files[a].crc32===t.v.crc32&&r.disk.files[a].date.getTime()===t.v.ctime.getTime()&&await blStore.set(r.deviceMAC+"_#BAK_"+e,t.v)}}async function re(e=!1){g={total:0,incnew:0,max:-1,mode:-1};let t=$("data.edt"),a=$("data.edt.old");await blStore.get(r.deviceMAC+"_data.edt.old");let n=blStore.result();await blStore.get(r.deviceMAC+"_data.edt");let i=blStore.result();if(void 0!==r.iparam&&(g.mode=parseInt(r.iparam[12]),2&g.mode?void 0!=r.sys_param&&(g.max=2*parseInt(r.sys_param[17])):g.max=r.disk.diskSize-102400),a>=0&&void 0!=i&&r.disk.files[a].date.getTime()===i.v.ctime.getTime()&&((n=i).k=r.deviceMAC+"_data.edt.old",i=void 0,console.log("Shift 'data.edt'->'data.edt.old'"),!0===e))try{await blStore.remove(r.deviceMAC+"_data.edt"),await blStore.set(n.k,n.v)}catch(e){return void(p="ERROR(Store): "+e)}if(void 0!=n&&(a<0||r.disk.files[a].date.getTime()!==n.v.ctime.getTime())&&(a=-1,n=void 0,!0===e))try{await blStore.remove(r.deviceMAC+"_data.edt.old")}catch(e){return void(p="ERROR(Store): "+e)}if(void 0!=i&&(t<0||r.disk.files[t].date.getTime()!==i.v.ctime.getTime())&&(i=void 0,!0===e))try{await blStore.remove(r.deviceMAC+"_data.edt")}catch(e){return void(p="ERROR(Store): "+e)}t>=0&&(g.total+=r.disk.files[t].len),a>=0&&(g.total+=r.disk.files[a].len),g.incnew=g.total,void 0!=i&&(g.incnew-=i.v.akt_len),void 0!=n&&(g.incnew-=n.v.akt_len),p=0}async function oe(e){const a=e.split(" ");let o,c;switch(a[0].toLowerCase()){case"q":case"quit":ge();break;case"cls":be=[],void 0!==Re&&(document.getElementById("blxTerminalOut").innerText="(cleared)");break;case"s":case"store":try{if(a.length<=1){await blStore.count();let e=0;const t=Date.now();me("Store: "+blStore.result()+" Items"),await blStore.iterate(function(a){const n=(i=t-a.ts,o="",(i/=1e3)>=86400&&(i-=86400*(r=Math.floor(i/86400)),o+=r+"d"),i-=3600*(r=Math.floor(i/3600)),r<10&&(o+="0"),o+=r+"h",i-=60*(r=Math.floor(i/60)),r<10&&(o+="0"),o+=r+"m",i<10&&(o+="0"),o+=Math.floor(i)+"s");var i,r,o;if(void 0!==a.v.akt_len){const t=a.v.akt_len;e+=t,me("'"+a.k+"' ("+n+")': "+t+" Bytes")}else me("'"+a.k+"' ("+n+")'")}),me("Total Data: "+(e/1024).toFixed(0)+" kB")}else switch(a[1]){case"c":case"clear":await blStore.clearStore(),me("Store cleared");break;case"r":case"remove":{let e;e=a.length<3?U:a[2],await blStore.remove(e),me("Removed '"+e+"' from Store")}break;case"l":case"list":try{let e;if(void 0===(e=a.length<3?U:a[2])){p="ERROR(Store): No Key";break}await blStore.get(e);const t=blStore.result();if(void 0===t){p="ERROR(Store): No Value for this Key";break}const n=(new TextDecoder).decode(t.v.bytebuf);let i=n.replace(/\r/g,"").split(/\n/);i.pop();const r=ue;ue<n.length+10&&(ue=n.length+10),me("List Key '"+t.k+"' Len: "+n.length+" Bytes => "+i.length+" Lines");let o=0;for(const e of i)me(o+": "+(e.length?e:"(empty)")),o++;ue=r}catch(e){p="ERROR(Store): "+e}break;case"m":case"modify":try{let e;const t=a[2];if(void 0===t){p="ERROR(Store): No Index";break}const i=a[3];if(void 0===(e=a.length<5?U:a[4])){p="ERROR(Store): No Key";break}await blStore.get(e);const r=blStore.result();if(void 0===r){p="ERROR(Store): No Value for this Key";break}let o=(new TextDecoder).decode(r.v.bytebuf).replace(/\r/g,"").split(/\n/);if(o.pop(),t<0||t>o.length){p="ERROR(Store): Index Range";break}let s=o[t];me("Old: "+t+": "+(s.length?s:"(empty)")),o[t]=i,me("New: "+t+": "+((s=o[t]).length?s:"(empty)"));const c=new TextEncoder;r.v.bytebuf=c.encode(o.join("\n")+"\n");const l=r.v.bytebuf.length;r.v.akt_len=l,r.v.crc32=n(r.v.bytebuf),r.v.ctime=new Date,r.v.pos0=0,r.v.total_len=l,r.v.ucl_flag=!1,await blStore.set(e,r.v)}catch(e){p="ERROR(Store): "+e}break;default:p="ERROR(Store): Unknown Cmd"}}catch(e){p="ERROR(Store): "+e}break;case"e":case"export":try{let e;e=a.length<2?U:a[1],await blStore.get(e);const t=blStore.result();if(void 0===t){p="ERROR(StoreExport): Key not found";break}!function(e){try{if(void 0===e.v||void 0===e.v.total_len||!e.v.total_len)return void(p="ERROR(Export): No Length or Empty!");const t=e.k.lastIndexOf(".");let a="application/octet-binary";if(t>1)switch(e.k.substr(t).toLowerCase()){case".jpg":a="image/jpeg";break;case".csv":a="application/csv;charset=utf-8";break;case".pdf":a="application/pdf";break;case".txt":case".log":a="text/plain;charset=utf-8"}const n=new Blob([e.v.bytebuf],{type:a}),i=e.k;saveAs(n,i),me("Export '"+i+"'")}catch(e){p="ERROR(Export): Export failed"}}(t)}catch(e){p="ERROR(StoreExport): "+e}break;case"a":case"audio":a.length>1&&(o=parseInt(a[1]),Ce=Boolean(o)),a.length>2&&(o=parseInt(a[2]),xe=Boolean(o)),me("Audio: RSSI: "+(Ce?"ON":"OFF")+", Term: "+(xe?"ON":"OFF"));break;case"f":{let e,t,n=440;a.length>1&&(n=parseInt(a[1])),a.length>2&&(e=parseInt(a[2])),a.length>3&&(t=parseInt(a[3])),Ae(n,e,t),me("Audio-Ping Frq:"+n+" Hz, (Dur: "+e+" Vol: "+t+")")}break;case"k":case"keep":a.length>1&&(o=parseInt(a[1]),X=Boolean(o)),me("Keep Connection: "+(X?"ON":"OFF"));break;case"rs":case"rssi":a.length>1&&(o=parseInt(a[1]),H=Boolean(o)),me("RSSI: "+(H?"ON":"OFF"));break;case"cf":case"connectionfast":a.length>1&&("f"===a[1].charAt(0).toLowerCase()?q="F":((o=parseInt(a[1]))<3?o=3:o>30&&(o=30),q=o.toString()));{let e;me("Fast Connection Speed: "+q+", Current: "+(e=void 0!==W?W:"(Unknown)"))}break;case"l":case"lines":a.length>1&&(o=parseInt(a[1])),ue=me("Lines: "+o);break;case"sl":case"sleep":a.length>1&&(o=parseInt(a[1])),me("Sleep: "+o+" msec..."),await t(o),me("...OK");break;case"d":case"disconnect":!0===b?d.gatt.disconnect():p="ERROR(Cmd): Not connected!";break;case"c":case"connect":!0===b&&d.gatt.disconnect(),await async function(){me("Connect: Discover Devices");try{const e=await navigator.bluetooth.requestDevice({filters:[{services:[s]}]});(d=e).addEventListener("gattserverdisconnected",j)}catch(e){p="ERROR(Discover): "+e}}(),p||await J(1,1);break;case"r":case"reconnect":!0===b?p="ERROR(Cmd): Already connected!":void 0===d?p="ERROR(Cmd): Nothing to Reconnect!":await J(0,1);break;case"i":case"identify":await ne(),await se(),!1===m&&(p="ERROR(Cmd): identify failed!");break;case"m":case"memory":if(await re(),!p){let e;e=g.max>0?(100*g.total/g.max).toFixed(2):"Unknown";let t="???";switch(g.mode){case 2:case 0:t="Rec.OFF";break;case 1:t="LINEAR";break;case 3:t="RING"}me("Data(Bytes): Total:"+g.total+"("+e+"%, "+t+"), New:"+g.incnew)}break;case"u":case"upload":await async function(e,t=!0){let a=!1;if(e.length>1&&(a=Boolean(parseInt(e[1]))),!t||(await ne(),!p)){for(;await Z("v",5e3),!p&&(!0===a&&(await blStore.remove(r.deviceMAC+"_data.edt"),await blStore.remove(r.deviceMAC+"_data.edt.old")),await re(!0),!p)&&(me("Available Data (Bytes): Total: "+g.total+", New: "+g.incnew),i&&(a?i("UPLOAD",g.total,"FULL"):i("UPLOAD",g.incnew,"INC")),await te("data.edt",a),!p);){await te("data.edt.old",a);break}t&&await ae()}}(a);break;case"x":case"xtract":{let e;if(void 0==(e=a.length<=1?r.deviceMAC:a[1])||16!=e.length){p="ERROR(xtract): MAC Error";break}me("Extract Data for MAC:'"+e+"' to Store"),await async function(e){await blStore.get(e+"_data.edt");let t=blStore.result();if(void 0==t)return void(p="ERROR(xtract): No Data");await blStore.get(e+"_data.edt.old");const a=blStore.result();if(void 0!==a){let e=new Uint8Array(t.v.bytebuf.length+a.v.bytebuf.length);e.set(a.v.bytebuf),e.set(t.v.bytebuf,a.v.bytebuf.length),t.v.bytebuf=e,t.v.total_len=e.length,t.v.akt_len=e.length}t.v.crc32=0,t.v.ctime=new Date;try{await blStore.set(e+"_xtract.edt",t.v)}catch(e){return void(p="ERROR(xtract): "+e)}}(e),p||me("Extracted")}break;case"g":case"get":await ee(a);break;case"p":case"put":{const e=a[1];me("Put File (Syncflag: "+e+")"),await async function(e,t){const a=document.createElement("input");a.type="file",void 0!==t&&(a.accept=t);a.onchange=(t=>{const a=t.target.files[0];me('Selected File:"'+a.name+'" Size:'+a.size+" LastModified: ["+a.lastModifiedDate.toLocaleDateString()+" "+a.lastModifiedDate.toLocaleTimeString()+"]");const n=new FileReader;n.onload=async function(){const t=new Uint8Array(n.result);t.length?(await de(t,a.name,e),p&&me(p)):me("ERROR: File is empty")},n.readAsArrayBuffer(a)}),me("Select File or Cancel"),a.click()}(e)}break;case"memput":{const e=parseInt(a[1]);if(isNaN(e)||e<=0||e%4){p="ERROR(memput): Address";break}me("Put File to Memory: 0x"+e.toString(16)+"/"+e),await async function(e){const t=document.createElement("input");t.type="file",t.onchange=(t=>{const a=t.target.files[0];me('Selected File:"'+a.name+'" Size:'+a.size+" LastModified: ["+a.lastModifiedDate.toLocaleDateString()+" "+a.lastModifiedDate.toLocaleTimeString()+"]");const i=new FileReader;i.onload=async function(){const t=new Uint8Array(i.result);t.length?(await de(t,void 0,!1,e),p&&me(p),me("Calculated CRC32: "+n(t).toString(16)+"("+t.length+" Bytes)")):me("ERROR: File is empty")},i.readAsArrayBuffer(a)}),me("Select File or Cancel"),t.click()}(e)}break;case"fput":{const e=a[1];if(void 0===e){p="ERROR(fput): No Filename";break}const t=e.substr(0,17),n=e.substr(17);if(17!==t.length||"_"!==t.charAt(16)||"#"===n.charAt(0)||n.length<1||n.length>21){p="ERROR(fput): Filename Error";break}try{await blStore.get(e);const a=blStore.result();if(void 0===a){p="ERROR(fput): No Value for this Key";break}const i=a.v.akt_len,r=a.v.esync_flag;if(!i){p="ERROR(fput): Empty File";break}me("Put File ('"+t+"...') '"+n+"' from Store"),me("(Len: "+i+" Bytes, Syncflag: "+r+")"),await de(a.v.bytebuf,n,r)}catch(e){p="ERROR(fput): "+e}}break;case"del":if(void 0===(c=a[1])||c.length<1||c.length>21){p="ERROR: Filename";break}await Z("D:"+c,1e4);break;case"format":{const e=parseInt(a[1]);e>0&&e<=2?(me("Wait... (up to 240 secs)"),await Z("F"+e,25e4)):p="ERROR: 'format 1'(Chip Erase) or 'format 2'(Soft)"}break;case"reset":if(me("Reset Device"),await Z(""),p)break;await Z("R",2e3),p=0;break;case"t":case"time":{let e="T";"set"===a[1]&&(e+=+(Date.now()/1e3).toFixed(0)),await Z(e,5e3)}break;default:p="ERROR(SysCmd): Command unknown"}}async function se(e=!0){let t=y;for(;t--;)if(await Z("~",5e3),!(p||(await Z("/",5e3),p||(await Z("T",5e3),p||(await Z("v",1e4),p||(await ie("sys_param.lxp",!1),p&&(me(p),p=0),await ie("iparam.lxp",!1),p&&(me(p),p=0),e&&await ae(),p)))))){m=!0,i&&i("CON",4,"Full Connected"),r.lastSeen=new Date,await ce();break}}async function ce(){let e=!1,t=!1;await blStore.get(r.deviceMAC+"_iparam.lxp");let a=blStore.result();void 0===a&&(await blStore.get(r.deviceMAC+"_#BAK_iparam.lxp"),void 0!==(a=blStore.result())&&(me("INFO: 'iparam.lxp' restored"),e=!0)),await blStore.get(r.deviceMAC+"_sys_param.lxp");let n,i,o=blStore.result();void 0===o&&(await blStore.get(r.deviceMAC+"_#BAK_sys_param.lxp"),void 0!==(o=blStore.result())&&(me("INFO: 'sys_param.lxp' restored"),t=!0)),void 0!==a&&((i=(n=(new TextDecoder).decode(a.v.bytebuf)).replace(/\r/g,"").split(/\n/)).pop(),i.length>19&&(r.iparam=i,r.iparam_dirtyflag=e)),void 0!=o&&((i=(n=(new TextDecoder).decode(o.v.bytebuf)).replace(/\r/g,"").split(/\n/)).pop(),i.length>=18&&(r.sys_param=i,r.sys_param_dirtyflag=t))}async function le(e,t,a=!0){a&&t>1e3&&(await ne(),p)||(await Z("G "+t+" "+e,6e5),a&&t>1e3&&await ae())}async function de(e,t,a,n){let i=e.length,r=0;const o=Date.now()-1e3;let s,c=o,l=V-2&65532;if(!(e.length>1e3&&(q<15&&void 0===t&&me("*** WARNING: Connection Speed: "+q),await ne(),p)||(void 0!==t?await Z("P"+(a?"!":"")+":"+t,5e3):await Z("I:"+n,5e3),p))){try{for(;;){let t=i;t>l&&(t=l);const a=new Uint8Array(t+2);a[0]=t,a[1]=h;const n=e.subarray(r,r+t);if(a.set(n,2),await f.writeValue(a.buffer),r+=t,!(i-=t)){const t=Date.now()-o;me("Transfer OK ("+t/1e3+" sec, "+(e.length/t*1e3).toFixed(0)+" Bytes/sec)");break}(s=Date.now())-c>1e3&&(c=s,me((100*r/e.length).toFixed(0)+"% / "+r+" Bytes"))}}catch(e){return void(p=!1===b?"ERROR: Connection lost":"ERROR: Transfer "+e)}await Z("L",5e3),p||e.length>1e3&&await ae()}}const fe=50;let ue,Re,be=[];function me(t){for(void 0!==t?be.push(t):be[0]="*** BLX Terminal "+e+" ***";be.length>ue;)be.shift();void 0!==Re&&(document.getElementById("blxTerminalOut").innerText=be.join("\n"))}function ve(e){13===e.keyCode||10===e.keycode?(e.preventDefault(),document.getElementById("blxTerminalSend").click()):27===e.keyCode&&(e.preventDefault(),document.getElementById("blxTerminalCmd").value="")}function pe(e){void 0!==Re&&(document.getElementById("blxTerminalSend").disabled=!e)}async function we(){const e=document.getElementById("blxTerminalCmd"),t=e.value.trim();e.value="",e.focus(),me("> "+t),pe(!1),xe&&Ae(1e3,.05,.1),p=0,t.startsWith(".")?await oe(t.substr(1)):await Z(t),await Q(),p&&(xe&&Ae(30,.2,.3),me(p)),pe(!0)}function ge(e,t,a=fe){void 0!==e?(ue=a,(Re=document.getElementById(e)).innerHTML="<div id='blxTerminalOut' style='border: 1px solid blue; margin: 3px'></div><div>Cmd: &gt <input id='blxTerminalCmd' typ='text' style='width: 80%;' maxlength='80'> <button id='blxTerminalSend'>Send</button></div>",document.getElementById("blxTerminalCmd").addEventListener("keyup",ve),document.getElementById("blxTerminalSend").addEventListener("click",we),document.getElementById("blxTerminalCmd").focus(),me(),pe(!0)):(void 0!==Re&&(Re.innerHTML=""),Re=void 0),void 0!==t&&("function"==typeof t?i=t:t=void 0)}function ye(e,t){let a="@"+t;for(let t=0;t<e.length;t++)if(e[t]===a)return t;return-1}function ke(e){let t=ye(e,0),a=ye(e,1);a<0&&(a=e.length);let n=a-t;if(t<0)throw"FATAL_ERROR: iparam defect: Channel #0 not found";if(14!==n)throw"FATAL_ERROR: iparam defect: <> 14 Parameters/Channel!";return n}function he(e,t,a){const n=parseInt(e);return isNaN(n)||n<t||n>a?1:0}function Se(e){const t=parseFloat(e);return isNaN(t)?1:0}const Oe=window.AudioContext||window.webkitAudioContext;let Ee=null,Ce=!1,xe=!0;function Ie(){xe&&Ae(3e3,.04,.02)}function Ae(e,t=.1,a=.05){Ee||(Ee=new Oe);const n=Ee.createOscillator();n.frequency.value=e;const i=Ee.createGain();i.gain.value=a,i.gain.exponentialRampToValueAtTime(a/5,Ee.currentTime+t),n.connect(i),i.connect(Ee.destination),n.type="square",n.start(),n.stop(Ee.currentTime+t)}return function(){if("https:"!==location.protocol&&"file:"!==location.protocol&&"content:"!==location.protocol&&"localhost"!==location.hostname){const e="https://"+location.hostname+location.pathname;return alert("BLX-API: HTTPS required. Jump to '"+e+"'"),void window.location.assign(e)}void 0!==navigator.bluetooth||alert("BLX-API: Browser does not support Bluetooth!")}(),{setTerminal:ge,userSendCmd:async e=>{if(await async function(e){const t=e.trim();me("=> "+t),p=0,t.startsWith(".")?await oe(t.substr(1)):await Z(t),await Q(),p&&me(p)}(e),p)throw p;if(!0===v)throw new Error("*** BLX BUSY (Since "+(Date.now()-R).toFixed(0)+" msec) ***")},getDevice:()=>r,getMemory:()=>g,frq_ping:Ae,getCrc32:n,IparamAddChannel:function(e,t){let a,n=0,i=parseInt(e[2]);for(;;){const t=ye(e,n);if(t<0)break;if(a=t,++n>=i)return!1}let r=ke(e);e.push("@"+n);for(let n=0;n<r-1;n++)!0===t&&void 0!==a?e.push(e[a+n+1]):e.push("");return!0},CompactIparam:function(e){let t=0;for(;;){let a=ye(e,t+1);if(a<0)break;if(!(parseInt(e[a+1])>0))break;t++}let a=ye(e,t)+ke(e);e.splice(a,999)},IparamValidate:function(e){if(e.length<19)return"300: Size ";if("@100"!==e[0])return"301: File Format (ID not '@100')";if(he(e[1],1,999999))return"302: DEVICE_TYP";if(he(e[2],1,90))return"303: MAX_CHANNELS";if(he(e[3],0,255))return"304: HK_FLAGS";if(10!==e[4].length)return"305: Cookie (10 Digits)";if(e[5].length>41)return"306: Device Name Len";if(he(e[6],10,86400))return"307: Period";if(he(e[7],0,parseInt(e[6])-1))return"308: Period Offset";if(he(e[8],0,parseInt(e[6])))return"309: Alarm Period";if(he(e[9],0,604799))return"310: Internet Period";if(he(e[10],0,parseInt(e[9])))return"311: Internet Period";if(he(e[11],-43200,43200))return"312: UTC Offset";if(he(e[12],0,255))return"313: Record Flags";if(he(e[13],0,255))return"314: HK Flags";if(he(e[14],0,255))return"315: HK Reload";if(he(e[15],0,255))return"316: Net Mode";if(he(e[16],0,255))return"317: Error Policy";if(he(e[17],-40,10))return"318: MinTemp oC";if(he(e[18],0,parseInt(e[9])))return"319: Internet Period";let t=ye(e,0);if(t<18)return"600: Missing #0";let a=0;for(;;){if(e.length-t<13)return"601: No of Params #"+a;if(he(e[t+1],0,255))return"602: Action #"+a;if(he(e[t+2],0,65535))return"603: PhysChan #"+a;if(e[t+3].length>8)return"604: KanCaps Len #"+a;if(he(e[t+4],0,255))return"605: SrcIndex #"+a;if(e[t+5].length>8)return"606: Unit Len #"+a;if(he(e[t+6],0,255))return"607: MemFormat #"+a;if(he(e[t+7],0,2147483647))return"608: DB_ID #"+a;if(Se(e[t+8]))return"609: Offset #"+a;if(Se(e[t+9]))return"610: Factor #"+a;if(Se(e[t+10]))return"611: Alarm_Hi #"+a;if(Se(e[t+11]))return"612: Alarm_Low #"+a;if(he(e[t+12],0,65535))return"613: MeasBits #"+a;if(e[t+13].length>32)return"614: XBytes Len #"+a;if(void 0===e[t+14])break;if(e[t+14]!=="@"+(a+1).toString())return"615: Unexpected Line #"+a;t+=14,a++}}}})();"undefined"!=typeof module&&void 0!==module.exports?module.exports.blx=blx:"function"==typeof define&&define.amd?define([],function(){return blx}):window.blx=blx;