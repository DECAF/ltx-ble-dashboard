const blx=(()=>{"use strict";const e="V1.12 / 05.10.2023",t="(C)JoEmbedded.de",n='BLX.JS and BlueShell are "living products". Questions and requests are always welcome.';async function a(e=1){return new Promise(t=>setTimeout(t,e))}const i=3988292384;function r(e){let t=4294967295;for(let n=0;n<e.length;n++){t^=e[n],t>>>=0;for(let e=0;e<8;e++)1&t?t=t>>>1^i:t>>>=1}return t>>>0}let o,s={},c=!1;const l="5c170001-b5a3-f393-e0a9-a37f42997c22",d="5c170002-b5a3-f393-e0a9-a37f42997c22",f="5c170003-b5a3-f393-e0a9-a37f42997c22";let u,R,b,v,g,m=!1,w=!1,p="",y=!1,h=!1,k=!1,S=0,E="?",O={total:0,incnew:0,max:-1,mode:0},C=!1,I=0;const x=3,A=16,D=17,T=32,N=33,_=34,F=35,B=1e4;let M,L,P,U,K,V,G,W,z,H,X,q,Y="unknown.dat";const j=20,J=40;let Z,Q,$,ee=!1,te=!1,ne="3",ae="15";function ie(){R=void 0,b=void 0,m=!1,c=!1,w=!1,y=!1,v=void 0,h=!1,!0===k&&"R"!==E?(Ie("Disconnected while Busy('"+E+"')"),S="ERROR: Disconnected ('"+E+"')"):Ie("Disconnected"),k=!1,o&&(void 0!==u?o("CON",1,"Reconnectable"):o("CON",0,"Disconnected"))}function re(e){const t=new Uint8Array(e.target.value.buffer),n=t.length;if(n<2)return Ie("ERROR(Data): NUS RX blocklen: "+n),void console.log(t);const a=t[0];if(a+2!==n)return Ie("ERROR(Data): NUS RX blocklen/dlen(0): "+n+"/"+a),void console.log(t);const i=t[1],r=t.subarray(2);let l,d,f,u;switch(i){case F:if(Ve(),"~"===(l=(new TextDecoder).decode(r)).charAt(0)&&l.length>1)switch(l.charAt(1)){case"G":d=parseInt(l.substring(3)),Ie((f=parseInt(l.substring(l.indexOf(" "))))?"Get "+d+" Bytes from Position "+f:"Get "+d+" Bytes"),G=d,z=0,W=new Uint8Array(d),H=Date.now(),X=H-1e3;break;case"A":v=l.substring(3);break;case"D":d=parseInt(l.substring(l.indexOf("DS:")+3)),f=parseInt(l.substring(l.indexOf("DA:")+3)),u=new Date(1e3*parseInt(l.substring(l.indexOf("DF:")+3))),Ie("Disksize: "+(d/1024).toFixed(0)+" kB / Available: "+(f/1024).toFixed(0)+" kB Formated: ["+u.toLocaleDateString()+" "+u.toLocaleTimeString()+"]"),s.disk={},s.disk.diskSize=d,s.disk.available=f,s.disk.formated=u,s.disk.files=[],c=!0;break;case'"':{d=l.lastIndexOf('"');const e=l.substring(2,d),t=l.substring(d);d=parseInt(t.substring(t.indexOf("L:")+2)),f=parseInt(t.substring(t.indexOf("CR:")+3),16),u=new Date(1e3*parseInt(t.substring(t.indexOf("T:")+2)));const n=t.indexOf("UC "),a=t.indexOf("ES ");let i="";n>0&&(i=" (Unclosed)"),isNaN(f)||(i+=" CRC: "+f.toString(16).toUpperCase()),a>0&&(i+=" ExtSync"),Ie(' - "'+e+'" Len: '+d+" Bytes"+i+" ["+u.toLocaleDateString()+" "+u.toLocaleTimeString()+"]");const r=[];r.fname=e,r.len=d,r.crc32=f,r.date=u,r.ucl_flag=Boolean(n>0),r.esync_flag=Boolean(a>0),s.disk.files.push(r),c=!0}break;case"X":te?(Ie("Keep Connection Ping..."),ce("")):(Ie("WARNING: Connection Auto-Disconnect soon"),o&&o("WARN",1,"Connection Auto-Disconnect soon"));break;case"e":{d=parseInt(l.substring(3));const e=l.substring(l.indexOf(" ")+1);f=parseInt(e),d>0&&f>0?e.indexOf(" ")>0?Ie("Measure ("+d+" Channels in "+f+" msec) Modemstate: "+(u=parseInt(e.substring(e.indexOf(" ")+1)))):Ie("Measure ("+d+" Channels in "+f+" msec)"):Ie("Measure..."),o&&(o("MEAS_CH",d,"Channels"),o("MEAS_T",f,"msec"))}break;case"H":case"#":{const e=parseInt(l.substring(2)),t=l.substring(l.indexOf(" ")+1).trim();if(isNaN(e))Ie("Warning: "+t),o&&o("MEAS_V","Warning",t);else{var R=e;e>=90&&(R="H"+e),Ie("("+R+")"+t),o&&o("MEAS_V",R,t)}}break;case"h":Ie("Alarmbits: "+(d=parseInt(l.substring(3))));break;case"@":d=parseInt(l.substring(2)),I=d,Ie("Wait max. "+(d/1e3).toFixed(0)+" secs");break;case"!":Ie("Info: "+(d=l.substring(2))),o&&o("INFO",0,d);break;case"M":{d=parseInt(l.substring(2));const e=l.substring(l.indexOf(" ")+1);Ie("Motion("+d+" Cnt), Measure in "+(f=parseInt(e))+" secs"),Ke&&(ze(100,.3,.2),ze(99,.3,.2))}break;case"Z":if(d=parseInt(l.substring(2)),f=0,(u=l.indexOf(" "))>0){const e=l.substring(u+1);f=parseInt(e)}switch(d){case 1:Ie(f>2?"Info: Measure (max. "+f+" sec)":"Info: Measure");break;case 9:Ie("Info: Internet in "+f+" sec");break;case 10:Ie("Info: Internet Transfer...");break;case 11:Ie(f?"Info: Internet Transfer Error:"+f:"Info: Internet Transfer OK")}o&&o("BZY",d,f);break;default:Ie("ERROR: '"+l+"' ???")}else{const e=l.trim();o&&o("MSG",0,e),Ie(k?"Reply: '"+e+"'":h?"Modem: '"+e+"'":"Info: '"+e+"'")}break;case N:if(Ve(),"~"===(l=(new TextDecoder).decode(r)).charAt(0)&&l.length>1)switch(l.charAt(1)){case"B":c=!0,s.deviceMAC="(UNKNOWN)",(u=l.indexOf(" "))>0?16===(f=l.substring(u+1)).length?(Ie("Device MAC:"+f),s.deviceMAC=f):S="ERROR: Invalid MAC":S="ERROR: No MAC",(d=parseInt(l.substring(3)))>=j&&d<250?(Ie("BLE Blocksize: "+(Z=d)+" Bytes"),d<J&&(Ie("WARNING: Small BLE Blocksize!"),o&&o("WARN",2,"Small BLE Blocksize!"))):S="ERROR: BLE Blocksize: "+d;break;case"C":d=parseInt(l.substring(3)),$=d,(u=l.indexOf(" "))>0?(f=parseInt(l.substring(u+1)))>1?S="ERROR: Connection Speed: ("+d+"): "+f:Ie("Connection Speed: "+(d>50?"Standard (":"Fast (")+d+")"):S="ERROR: Connection Speed";break;case"T":{d=parseInt(l.substring(3));const e=new Date(1e3*d);let t,n=(Date.now()/1e3-d).toFixed(0);const a=l.substring(l.indexOf(" ")+1);f=parseInt(a),n>864e3||n<-864e3?t=" (Warning: DeviceTime Lost!)":(n<=1&&n>=-1&&(n=0),t=" (Delta to App: "+n+" sec)"),f&&(t+="(Run: "+(f/86400).toFixed(1)+" d)"),s.deltaToApp=n,Ie("Time: ["+e.toLocaleDateString()+" "+e.toLocaleTimeString()+"] "+t)}break;case"V":{const e=l.split(" ");d=parseInt(l.substring(3)),f=parseInt(e[1]),u=new Date(1e3*parseInt(e[2])),s.deviceType=d,s.firmwareVersion=(f/10).toFixed(1),s.firmwareBuilt=u.toUTCString(),s.cpu=-1,e.length>3&&(s.cpu=parseInt(e[3])),s.deviceHasInternet=0,e.length>4&&(s.deviceHasInternet=parseInt(e[4])),Ie("DeviceType: "+d+" V"+s.firmwareVersion+" (Built: "+s.firmwareBuilt+") CPU:"+s.cpu),s.deviceHasInternet&&Ie("Device has Internet"),y=!0}break;case"E":y=!1,S="PIN ERROR",Ie("ERROR: PIN ERROR"),Ge();break;case"N":d=parseInt(l.substring(3)),f=new Date(1e3*parseInt(l.substring(l.indexOf(" ")+1))),Ie("Filesize: "+d+" Bytes"),M=d,L=f;break;case"L":Ie((d=parseInt(l.substring(3)))+" Bytes transferred");break;case"P":Ie("File Ready"),C=!0;break;case"I":Ie("Memory Ready"),C=!0;break;case"K":break;default:Ie("ERROR: '"+l+"' ???"),S=l}else Ie("End: '"+l+"' (Runtime: "+(Date.now()-g).toFixed(0)+" msec)"),l.startsWith("ERR")&&(S=l);k=!1,h=!1;break;case T:switch((l=(new TextDecoder).decode(r)).charAt(0)){case"R":(d=parseInt(l.substring(2)))<-199&&d>=0?(Q="[NoSignal]",d=-200):Q=d,ee&&Ie("Signal (dBm):"+Q),Ue&&function(e){if(e>199)ze(30,.2,.3);else{e<30&&(e=30);const t=100*Math.pow(2,(100-e)/12);ze(t,.5,.15)}}(-d),o&&o("RSSI",d," dBm");break;case"V":d=l.substring(3),o&&o("VSENS",d,l.charAt(1));break;default:Ie("Info: '"+l+"'")}break;case _:{if(d=G-z,r.length>d){S="ERROR: Too many data";break}W.set(r,z),z+=a;const e=Date.now();if(e-X>1e3&&(d=(z/G*100).toFixed(0),o&&o("PROG",d,"%"),Ie("Get: "+d+"% / "+z+" Bytes"),X=e),0===(d=G-z)){let e=Date.now()-H;e||e++;const t=(z/e*1e3).toFixed(0);Ie("Get OK ("+e/1e3+" sec, "+t+" Bytes/sec)"),o&&o("GET_OK",t,"Bytes/sec")}}break;default:Ie("ERROR(Data): '"+l+"'")}}async function oe(e,t,n=x){if(void 0===u)return void(S="ERROR(Connect): Undefined Device");if(null===u.name)return void(S="ERROR(Connect): Unknown Device Name");e&&((s={}).advertisingName=u.name,c=!0),o&&o("CON",2,"Connecting...");let a=0;for(;;){try{Ie(e?"Connect to '"+u.name+"'...":"Reconnect to '"+u.name+"'..."),a++;const t=await u.gatt.connect(),i=await t.getPrimaryService(l);R=await i.getCharacteristic(d),b=await i.getCharacteristic(f),await b.startNotifications(),b.addEventListener("characteristicvaluechanged",re),Ie("Connected"),m=!0,o&&o("CON",3,"Connected, Identify..."),a=n,S=0}catch(e){Ie("RETRY(Connect("+a+"), Reason: '"+e.message.substring(0,40)+"...')"),S="ERROR(Connect("+a+")): '"+e.message+"'"}if(a>=n)break;const t="Failed, Retry to connect ("+(n-a+1)+" left)...";o&&o("WARN",5,t),Ie(t)}m&&(t&&await we(!1),await ue(),!0===y&&We(500))}async function se(){if(c){c=!1;const e=s.deviceMAC+"_#BlxIDs";try{await blStore.set(e,s)}catch(e){S="ERROR(CheckIDs): "+e}}}async function ce(e,t=B){if(!0!==k){if(!0!==m){if(void 0===u)return void(S="ERROR(DeviceCmd): Not Connected!");if(await oe(0,1),S)return}e.startsWith("#")&&(h=!0),!1===h&&(k=!0),E=e,g=Date.now(),await async function(e,t=A){const n=e.length,a=new Uint8Array(n+2),i=a.subarray(2);if(a[0]=n,a[1]=t,void 0!==(new TextEncoder).encodeInto(e,i))try{R.writeValue(a.buffer)}catch(e){let t;S="ERROR(DeviceSend): "+(t=!1===m?"Connection lost":e)}}(e),!1===h&&(await async function(e){for(I=e;!0===k;)if(await a(10),(I-=10)<0){S="ERROR(DeviceCmd): Timeout ('"+E+"')";break}}(t),k=!1)}else console.warn("*** BLX BUSY (Since "+(Date.now()-g).toFixed(0)+" msec) ***")}function le(e){let t=-1;for(let n=0;n<s.disk.files.length;n++)if(s.disk.files[n].fname===e){t=n;break}return t<0?(S="ERROR(Cmd): File not in Directory",-1):t}async function de(e,t=!0){let n;if(void 0===(n=e[1])||n.length<1||n.length>21)return void(S="ERROR(Cmd): Filename");if(void 0===s.disk||void 0===s.disk.files)return void(S="ERROR(Cmd): No Disk Info");let a=le(n);if(a<0)return;if(M=-1,Y=n,q=void 0,await ce("N:"+n),S)return;if(M<0)return void(S="ERROR(SysCmd): No File");if(Ie('Get File "'+n+'": Total Len: '+M+" Bytes"),M!==s.disk.files[a].len)return void(S="ERROR(SysCmd): File Size changed");if(s.disk.files[a].date.getTime()!==L.getTime())return void(S="ERROR(SysCmd): File Date changed");P=s.disk.files[a].crc32,U=s.disk.files[a].ucl_flag,K=s.disk.files[a].esync_flag;let i=M,r=0;e[2]&&(r=parseInt(e[2]),i=e[3]?parseInt(e[3]):M-r),r<0||i<1||r+i>M?S="ERROR(SysCmd): Out of range of File":(V=r,o&&o("GET",i,n),await ye(r,i,t),S||async function(){if(void 0===z||!z)return void(S="ERROR(Store): No Data to store");if(void 0===W||W.length!==G)return void(S="ERROR(Store): Inconsistent Data");const e=s.deviceMAC+"_"+Y,t=[];t.total_len=M,t.pos0=V,t.akt_len=G,t.ctime=L,t.crc32=P,t.ucl_flag=U,t.esync_flag=K,t.bytebuf=W;try{await blStore.set(e,t)}catch(e){return void(S="ERROR(Store): "+e)}Ie("Save to Store '"+e+"'"),W=void 0,q=e}())}async function fe(e,t){let n,a,i,r;if((n=le(e))>=0){if(await blStore.get(s.deviceMAC+"_"+e),void 0===(a=blStore.result())||!0===t){if(await de([0,e],!1),S)return}else if((i=s.disk.files[n].len-a.v.akt_len)>0){if(o&&o("GET",i,e),Ie('Get File (Missing Part) "'+e+'": Len: '+i+" Bytes"),await async function(e,t,n){M=-1,Y=void 0,q=void 0,await ce("N:"+e),S||(M<0?S="ERROR(SysCmd): No File '"+e+"'":(P=0,U=!0,K=!1,V=t,M=n,await ye(t,n,!1)))}(e,a.v.akt_len,i),S)return;if(W.length!==i)return void(S="ERROR(upload): Read Len");(r=new Uint8Array(a.v.bytebuf.length+i)).set(a.v.bytebuf),r.set(W,a.v.bytebuf.length),a.v.bytebuf=r,a.v.total_len+=i,a.v.akt_len+=i;try{await blStore.set(a.k,a.v)}catch(e){S="ERROR(upload): "+e}}}else S=""}async function ue(){for(let e=0;e<3&&(await a(1e3),$=-1,void 0===R?S="Disconnected":await ce("CS",32e3),!S)&&!($>0);e++);}async function Re(){for(let e=0;e<4&&(await a(1e3),$=-1,await ce("C"+ne,32e3),!S)&&!($<=50);e++){let t=parseInt(ne);if(isNaN(t))break;e>0&&(ne=(++t).toString())}}async function be(e,t=!0){const n=le(e);await blStore.get(s.deviceMAC+"_"+e);const a=blStore.result();if(n<0)return void 0!==a&&await blStore.remove(a.k),S="ERROR(identify): No File '"+e+"' on Device",void(o&&o("WARN",3,"No File '"+e+"' on Device"));if(s.disk.files[n].len<=0||!0===s.disk.files[n].ucl_flag)return S="ERROR(identify): File corrupt '"+e+"' on Device",void(o&&o("WARN",4,"File corrupt '"+e+"' on Device"));if((void 0===a||s.disk.files[n].len!==a.v.akt_len||s.disk.files[n].crc32!==a.v.crc32||s.disk.files[n].date.getTime()!==a.v.ctime.getTime())&&(await de([0,e],t),!S)){await blStore.get(s.deviceMAC+"_"+e);const t=blStore.result();void 0!==t&&s.disk.files[n].len===t.v.akt_len&&s.disk.files[n].crc32===t.v.crc32&&s.disk.files[n].date.getTime()===t.v.ctime.getTime()&&await blStore.set(s.deviceMAC+"_#BAK_"+e,t.v)}}async function ve(e=!1){O={total:0,incnew:0,max:-1,mode:-1};let t=le("data.edt"),n=le("data.edt.old");await blStore.get(s.deviceMAC+"_data.edt.old");let a=blStore.result();await blStore.get(s.deviceMAC+"_data.edt");let i=blStore.result();if(void 0!==s.iparam&&(O.mode=parseInt(s.iparam[12]),2&O.mode?void 0!=s.sys_param&&(O.max=2*parseInt(s.sys_param[17])):O.max=s.disk.diskSize-102400),n>=0&&void 0!=i&&s.disk.files[n].date.getTime()===i.v.ctime.getTime()&&((a=i).k=s.deviceMAC+"_data.edt.old",i=void 0,console.log("Shift 'data.edt'->'data.edt.old'"),!0===e))try{await blStore.remove(s.deviceMAC+"_data.edt"),await blStore.set(a.k,a.v)}catch(e){return void(S="ERROR(Store): "+e)}if(void 0!=a&&(n<0||s.disk.files[n].date.getTime()!==a.v.ctime.getTime())&&(n=-1,a=void 0,!0===e))try{await blStore.remove(s.deviceMAC+"_data.edt.old")}catch(e){return void(S="ERROR(Store): "+e)}if(void 0!=i&&(t<0||s.disk.files[t].date.getTime()!==i.v.ctime.getTime())&&(i=void 0,!0===e))try{await blStore.remove(s.deviceMAC+"_data.edt")}catch(e){return void(S="ERROR(Store): "+e)}t>=0&&(O.total+=s.disk.files[t].len),n>=0&&(O.total+=s.disk.files[n].len),O.incnew=O.total,void 0!=i&&(O.incnew-=i.v.akt_len),void 0!=a&&(O.incnew-=a.v.akt_len),S=0}async function ge(e,t){let n=e.toString(16).toUpperCase().padStart(8,"0");const a=new Uint8Array(16);(new TextEncoder).encodeInto(n,a);const i=new Uint8Array(16);(new TextEncoder).encodeInto(t,i);const r=await window.crypto.subtle.importKey("raw",a,{name:"AES-CBC",length:128},!1,["encrypt","decrypt"]),o=new Uint8Array(16);return(await crypto.subtle.encrypt({name:"AES-CBC",iv:o},r,i).then(function(e){let t=new Uint8Array(e);return new DataView(t.buffer).getUint32(0)})).toString(16)}async function me(e){const t=e.split(" ");let n,i;const c=t[0].toLowerCase();if(!0!==h)switch(c){case"q":case"quit":Ne();break;case"cls":Ce=[],void 0!==Oe&&(document.getElementById("blxTerminalOut").innerText="(cleared)");break;case"s":case"store":try{if(t.length<=1){await blStore.count();let e=0;const t=Date.now();Ie("Store: "+blStore.result()+" Items"),await blStore.iterate(function(n){const a=(i=t-n.ts,o="",(i/=1e3)>=86400&&(i-=86400*(r=Math.floor(i/86400)),o+=r+"d"),i-=3600*(r=Math.floor(i/3600)),r<10&&(o+="0"),o+=r+"h",i-=60*(r=Math.floor(i/60)),r<10&&(o+="0"),o+=r+"m",i<10&&(o+="0"),o+=Math.floor(i)+"s");var i,r,o;if(void 0!==n.v.akt_len){const t=n.v.akt_len;e+=t,Ie("'"+n.k+"' ("+a+")': "+t+" Bytes")}else Ie("'"+n.k+"' ("+a+")'")}),Ie("Total Data: "+(e/1024).toFixed(0)+" kB")}else switch(t[1]){case"c":case"clear":await blStore.clearStore(),Ie("Store cleared");break;case"r":case"remove":{let e;e=t.length<3?q:t[2],await blStore.remove(e),Ie("Removed '"+e+"' from Store")}break;case"l":case"list":try{let e;if(void 0===(e=t.length<3?q:t[2])){S="ERROR(Store): No Key";break}await blStore.get(e);const n=blStore.result();if(void 0===n){S="ERROR(Store): No Value for this Key";break}const a=(new TextDecoder).decode(n.v.bytebuf);let i=a.replace(/\r/g,"").split(/\n/);i.pop();const r=Ee;Ee<a.length+10&&(Ee=a.length+10),Ie("List Key '"+n.k+"' Len: "+a.length+" Bytes => "+i.length+" Lines");let o=0;for(const e of i)Ie(o+": "+(e.length?e:"(empty)")),o++;Ee=r}catch(e){S="ERROR(Store): "+e}break;case"m":case"modify":try{let e;const n=t[2];if(void 0===n){S="ERROR(Store): No Index";break}const a=t[3];if(void 0===(e=t.length<5?q:t[4])){S="ERROR(Store): No Key";break}await blStore.get(e);const i=blStore.result();if(void 0===i){S="ERROR(Store): No Value for this Key";break}let o=(new TextDecoder).decode(i.v.bytebuf).replace(/\r/g,"").split(/\n/);if(o.pop(),n<0||n>o.length){S="ERROR(Store): Index Range";break}let s=o[n];Ie("Old: "+n+": "+(s.length?s:"(empty)")),o[n]=a,Ie("New: "+n+": "+((s=o[n]).length?s:"(empty)"));const c=new TextEncoder;i.v.bytebuf=c.encode(o.join("\n")+"\n");const l=i.v.bytebuf.length;i.v.akt_len=l,i.v.crc32=r(i.v.bytebuf),i.v.ctime=new Date,i.v.pos0=0,i.v.total_len=l,i.v.ucl_flag=!1,await blStore.set(e,i.v)}catch(e){S="ERROR(Store): "+e}break;default:S="ERROR(Store): Unknown Cmd"}}catch(e){S="ERROR(Store): "+e}break;case"e":case"export":try{let e;e=t.length<2?q:t[1],await blStore.get(e);const n=blStore.result();if(void 0===n){S="ERROR(StoreExport): Key not found";break}!function(e){try{if(void 0===e.v||void 0===e.v.total_len||!e.v.total_len)return void(S="ERROR(Export): No Length or Empty!");const t=e.k.lastIndexOf(".");let n="application/octet-binary";if(t>1)switch(e.k.substring(t).toLowerCase()){case".jpg":n="image/jpeg";break;case".csv":n="application/csv;charset=utf-8";break;case".pdf":n="application/pdf";break;case".txt":case".log":n="text/plain;charset=utf-8"}const a=new Blob([e.v.bytebuf],{type:n}),i=e.k;saveAs(a,i),Ie("Export '"+i+"'")}catch(e){S="ERROR(Export): Export failed"}}(n)}catch(e){S="ERROR(StoreExport): "+e}break;case"a":case"audio":t.length>1&&(n=parseInt(t[1]),Ue=Boolean(n)),t.length>2&&(n=parseInt(t[2]),Ke=Boolean(n)),Ie("Audio: RSSI: "+(Ue?"ON":"OFF")+", Term: "+(Ke?"ON":"OFF"));break;case"f":{let e,n,a=440;t.length>1&&(a=parseInt(t[1])),t.length>2&&(e=parseInt(t[2])),t.length>3&&(n=parseInt(t[3])),ze(a,e,n),Ie("Audio-Ping Frq:"+a+" Hz, (Dur: "+e+" Vol: "+n+")")}break;case"k":case"keep":t.length>1&&(n=parseInt(t[1]),te=Boolean(n)),Ie("Keep Connection: "+(te?"ON":"OFF"));break;case"rs":case"rssi":t.length>1&&(n=parseInt(t[1]),ee=Boolean(n)),Ie("RSSI: "+(ee?"ON":"OFF"));break;case"cf":case"connectionfast":t.length>1&&("f"===t[1].charAt(0).toLowerCase()?ne="F":((n=parseInt(t[1]))<3?n=3:n>30&&(n=30),ne=n.toString()),t.length>2&&((n=parseInt(t[1]))<3?n=3:n>30&&(n=30),ae=n.toString()));{let e;Ie("Fast Connection Speed: "+ne+", Current: "+(e=void 0!==$?$:"(Unknown)")),Ie("Fast Memory Download Speed: "+ae)}break;case"l":case"lines":t.length>1&&(Ee=parseInt(t[1])),Ie("Lines: "+Ee);break;case"sl":case"sleep":t.length>1&&(n=parseInt(t[1])),Ie("Sleep: "+n+" msec..."),await a(n),Ie("...OK");break;case"d":case"disconnect":!0===m?u.gatt.disconnect():S="ERROR(Cmd): Not connected!";break;case"c":case"connect":!0===m&&u.gatt.disconnect(),t.length>1&&(p=t[1]),await async function(){Ie("Connect: Discover Devices");try{const e=await navigator.bluetooth.requestDevice({filters:[{services:[l]}]});(u=e).addEventListener("gattserverdisconnected",ie)}catch(e){S="ERROR(Discover): "+e}}(),S||await oe(1,1);break;case"r":case"reconnect":t.length>1&&(p=t[1]),!0===m?S="ERROR(Cmd): Already connected!":void 0===u?S="ERROR(Cmd): Nothing to Reconnect!":await oe(0,1);break;case"i":case"identify":t.length>1&&(p=t[1]),await Re(),await we(),!1===w&&(S="ERROR(Cmd): identify failed!"),!0===y&&We(500);break;case"m":case"memory":if(await ve(),!S){let e;e=O.max>0?(100*O.total/O.max).toFixed(2):"Unknown";let t="???";switch(O.mode){case 2:case 0:t="Rec.OFF";break;case 1:t="LINEAR";break;case 3:t="RING"}Ie("Data(Bytes): Total:"+O.total+"("+e+"%, "+t+"), New:"+O.incnew)}break;case"u":case"upload":await async function(e,t=!0){let n=!1;if(e.length>1&&(n=Boolean(parseInt(e[1]))),!t||(await Re(),!S)){for(;await ce("v",5e3),!S&&(!0===n&&(await blStore.remove(s.deviceMAC+"_data.edt"),await blStore.remove(s.deviceMAC+"_data.edt.old")),await ve(!0),!S)&&(Ie("Available Data (Bytes): Total: "+O.total+", New: "+O.incnew),o&&(n?o("UPLOAD",O.total,"FULL"):o("UPLOAD",O.incnew,"INC")),await fe("data.edt",n),!S);){await fe("data.edt.old",n);break}t&&await ue()}}(t);break;case"x":case"xtract":{let e;if(void 0==(e=t.length<=1?s.deviceMAC:t[1])||16!=e.length){S="ERROR(xtract): MAC Error";break}Ie("Extract Data for MAC:'"+e+"' to Store"),await async function(e){await blStore.get(e+"_data.edt");let t=blStore.result();if(void 0==t)return void(S="ERROR(xtract): No Data");await blStore.get(e+"_data.edt.old");const n=blStore.result();if(void 0!==n){let e=new Uint8Array(t.v.bytebuf.length+n.v.bytebuf.length);e.set(n.v.bytebuf),e.set(t.v.bytebuf,n.v.bytebuf.length),t.v.bytebuf=e,t.v.total_len=e.length,t.v.akt_len=e.length}t.v.crc32=0,t.v.ctime=new Date;try{await blStore.set(e+"_xtract.edt",t.v)}catch(e){return void(S="ERROR(xtract): "+e)}}(e),S||Ie("Extracted")}break;case"g":case"get":await de(t);break;case"p":case"put":{let e=t[1];void 0===e&&(e=0),Ie("Put File (Syncflag: "+e+")"),await ke(e)}break;case"firmware":if(Ie("Firmware Update"),blxDevice.deviceType>=1e3||void 0!==blxDevice.disk&&blxDevice.disk.diskSize>0){await ke(0,".sec");break}case"memput":{let e,t;if(32==s.cpu)e=294912,t=163840;else{if(40!=s.cpu){S="ERROR(memput): Unknown CPU";break}e=626688,t=356352}let n="firmware"==c;await async function(e,t,n=!1){const i=document.createElement("input");i.type="file",i.onchange=(i=>{const o=i.target.files[0];Ie('Selected File:"'+o.name+'" Size:'+o.size+" LastModified: ["+o.lastModifiedDate.toLocaleDateString()+" "+o.lastModifiedDate.toLocaleTimeString()+"]");const s=new FileReader;s.onload=async function(){const i=new Uint8Array(s.result);i.length?i.length>t?Ie("ERROR: File too large"):(await he(i,void 0,!1,e),S&&Ie(S),Ie("Calculated CRC32: "+r(i).toString(16)+"("+i.length+" Bytes)"),!0===n&&(Ie("Reset Device"),await ce("R",2e3),await a(1e3),S=0)):Ie("ERROR: File is empty")},s.readAsArrayBuffer(o)}),Ie("Select File or Cancel"),i.click()}(e,t,n)}break;case"fput":{const e=t[1];if(void 0===e){S="ERROR(fput): No Filename";break}const n=e.substring(0,17),a=e.substring(17);if(17!==n.length||"_"!==n.charAt(16)||"#"===a.charAt(0)||a.length<1||a.length>21){S="ERROR(fput): Filename Error";break}try{await blStore.get(e);const t=blStore.result();if(void 0===t){S="ERROR(fput): No Value for this Key";break}const i=t.v.akt_len,r=t.v.esync_flag;if(!i){S="ERROR(fput): Empty File";break}Ie("Put File ('"+n+"...') '"+a+"' from Store"),Ie("(Len: "+i+" Bytes, Syncflag: "+r+")"),await he(t.v.bytebuf,a,r)}catch(e){S="ERROR(fput): "+e}}break;case"del":if(void 0===(i=t[1])||i.length<1||i.length>21){S="ERROR: Filename";break}await ce("D:"+i,1e4);break;case"format":{const e=parseInt(t[1]);e>0&&e<=2?(Ie("Wait... (up to 240 secs)"),await ce("F"+e,25e4)):S="ERROR: 'format 1'(Chip Erase) or 'format 2'(Soft)"}break;case"reset":if(Ie("Reset Device"),await ce(""),S)break;await ce("R",2e3),await a(1e3),S=0;break;case"t":case"time":{let e="T";"set"===t[1]&&(e+=+(Date.now()/1e3).toFixed(0)),await ce(e,5e3)}break;default:S="ERROR(SysCmd): Command unknown"}else S='ERROR(Modem): Exit Modem Terminal ("~")!'}async function we(e=!0){let t,n=x,a=!0;for(y=!1;n--;){if(await ce("~",5e3),S)continue;!0===a&&(await blStore.get(s.deviceMAC+"_#PIN"),void 0!==(t=blStore.result())&&t.v.length&&(p=t.v),a=!1);let n=p;if(void 0!==v){let e=parseInt(p);if(isNaN(e))return Ie("ERROR: "+(S="PIN required")),void Ge();n=await ge(e,v)}if(await ce("/"+n,5e3),!0!==y)return await blStore.remove(s.deviceMAC+"_#PIN"),void(e&&await ue());if(!S&&(await ce("T",5e3),!S)){if(s.deviceType>=200&&s.deviceType<1e3)o&&o("MSG",1,"Sensor, No Disk");else{if(await ce("v",1e4),S)continue;await ce("Y"),S&&(Ie(S),S=0),await be("sys_param.lxp",!1),S&&(Ie(S),S=0),await ce("X"),S&&(Ie(S),S=0),await be("iparam.lxp",!1),S&&(Ie(S),S=0),s.diskCheckOK=!0,await ce("V",1e4),S&&(Ie(S),S=0,s.diskCheckOK=!1)}if(e&&await ue(),!S){w=!0,o&&o("CON",4,"Full Connected"),s.lastSeen=new Date,!0===y&&p.length&&!isNaN(Number(p))&&await blStore.set(s.deviceMAC+"_#PIN",p),await pe();break}}}}async function pe(){let e=!1,t=!1;await blStore.get(s.deviceMAC+"_iparam.lxp");let n=blStore.result();void 0===n&&(await blStore.get(s.deviceMAC+"_#BAK_iparam.lxp"),void 0!==(n=blStore.result())&&(Ie("INFO: 'iparam.lxp' restored"),e=!0)),await blStore.get(s.deviceMAC+"_sys_param.lxp");let a,i,r=blStore.result();void 0===r&&(await blStore.get(s.deviceMAC+"_#BAK_sys_param.lxp"),void 0!==(r=blStore.result())&&(Ie("INFO: 'sys_param.lxp' restored"),t=!0)),void 0!==n&&((i=(a=(new TextDecoder).decode(n.v.bytebuf)).replace(/\r/g,"").split(/\n/)).pop(),i.length>19&&(s.iparam=i,s.iparam_dirtyflag=e)),void 0!=r&&((i=(a=(new TextDecoder).decode(r.v.bytebuf)).replace(/\r/g,"").split(/\n/)).pop(),i.length>=18&&(s.sys_param=i,s.sys_param_dirtyflag=t))}async function ye(e,t,n=!0){n&&t>1e3&&(await Re(),S)||(await ce("G "+t+" "+e,6e5),n&&t>1e3&&await ue())}async function he(e,t,n,a){let i=e.length,r=0;const o=Date.now()-1e3;let s,c=o,l=Z-2&65532;if(e.length>1e3){if(void 0===t){ae<15&&Ie("*** WARNING: Memory Connection Speed: "+ae);const e=ne;ne=ae,await Re(),ne=e}else await Re();if(S)return}if(C=!1,void 0!==t)await ce("P"+(n?"!":"")+":"+t,5e3);else{{let e=a,t=i;const n=4096;for(;t>0;){if(await ce("K:"+e+" 1",5e3),S)return;e+=n,t-=n}}await ce("I:"+a,5e3)}if(!S)if(!0===C){try{for(;;){let t=i;t>l&&(t=l);const n=new Uint8Array(t+2);n[0]=t,n[1]=D;const a=e.subarray(r,r+t);if(n.set(a,2),await R.writeValue(n.buffer),r+=t,!(i-=t)){const t=Date.now()-o;Ie("Transfer OK ("+t/1e3+" sec, "+(e.length/t*1e3).toFixed(0)+" Bytes/sec)");break}(s=Date.now())-c>1e3&&(c=s,Ie((100*r/e.length).toFixed(0)+"% / "+r+" Bytes"))}}catch(e){return void(S=!1===m?"ERROR: Connection lost":"ERROR: Transfer "+e)}await ce("L",5e3),S||e.length>1e3&&await ue()}else S="ERROR: File Send Error"}async function ke(e,t){const n=document.createElement("input");n.type="file",void 0!==t&&(n.accept=t),n.onchange=(n=>{const i=n.target.files[0];if(Ie('Selected File:"'+i.name+'" Size:'+i.size+" LastModified: ["+i.lastModifiedDate.toLocaleDateString()+" "+i.lastModifiedDate.toLocaleTimeString()+"]"),void 0!==t&&".sec"==t){let e="firmware_typ"+s.deviceType+"_";if(!i.name.startsWith(e)&&"_firmware.sec"==!i.name)return void Ie(S="ERROR: No Firmware File for this Device")}const r=new FileReader;r.onload=async function(){const n=new Uint8Array(r.result);if(!n.length)return void Ie(S="ERROR: File is empty");let o=i.name;void 0!==t&&".sec"==t&&(o="_firmware.sec"),await he(n,o,e),S&&Ie(S),void 0!==t&&".sec"==t&&(Ie("Reset Device"),await ce("R",2e3),await a(1e3),S=0)},r.readAsArrayBuffer(i)}),Ie("Select File or Cancel"),n.click()}const Se=25;let Ee,Oe,Ce=[];function Ie(n){for(void 0!==n?Ce.push(n):Ce[0]="*** BLX Terminal "+e+" "+t+" ***";Ce.length>Ee;)Ce.shift();void 0!==Oe&&(document.getElementById("blxTerminalOut").innerText=Ce.join("\n"))}function xe(e){13===e.keyCode||10===e.keycode?(e.preventDefault(),document.getElementById("blxTerminalSend").click()):27===e.keyCode&&(e.preventDefault(),document.getElementById("blxTerminalCmd").value="")}function Ae(e){void 0!==Oe&&(document.getElementById("blxTerminalSend").disabled=!e)}let De="";async function Te(){const e=document.getElementById("blxTerminalCmd");let a=e.value.trim();if(e.value="",e.focus(),Ie("> "+a),Ae(!1),Ke&&ze(1e3,.05,.1),S=0,"*"==a&&De.length?a=De:a.length&&(De=a),"help"==a||"-h"==a||"/h"==a||"-?"==a||"/?"==a)return Ie(n),void Ie(t);a.startsWith(".")?await me(a.substring(1)):await ce(a),await se(),S&&(Ge(),Ie(S)),Ae(!0)}function Ne(e,t,n=Se){void 0!==e?(Ee=n,(Oe=document.getElementById(e)).innerHTML="<div id='blxTerminalOut' style='border: 1px solid blue; margin: 3px'></div><div>Cmd: &gt <input id='blxTerminalCmd' typ='text' style='width: 80%;' maxlength='80'> <button id='blxTerminalSend'>Send</button></div>",document.getElementById("blxTerminalCmd").addEventListener("keyup",xe),document.getElementById("blxTerminalSend").addEventListener("click",Te),document.getElementById("blxTerminalCmd").focus(),Ie(),Ae(!0)):(void 0!==Oe&&(Oe.innerHTML=""),Oe=void 0),void 0!==t&&("function"==typeof t?o=t:t=void 0)}function _e(e,t){let n="@"+t;for(let t=0;t<e.length;t++)if(e[t]===n)return t;return-1}function Fe(e){let t=_e(e,0),n=_e(e,1);n<0&&(n=e.length);let a=n-t;if(t<0)throw"FATAL_ERROR: iparam defect: Channel #0 not found";if(14!==a)throw"FATAL_ERROR: iparam defect: <> 14 Parameters/Channel!";return a}function Be(e,t,n){const a=parseInt(e);return isNaN(a)||a<t||a>n?1:0}function Me(e){const t=parseFloat(e);return isNaN(t)?1:0}const Le=window.AudioContext||window.webkitAudioContext;let Pe=null,Ue=!1,Ke=!0;function Ve(){Ke&&ze(3e3,.04,.02)}function Ge(){Ke&&ze(30,.2,.3)}function We(e,t=.3,n=.05){Ke&&(ze(e,t,n),ze(1.259*e,t,n),ze(1.498*e,t,n))}function ze(e,t=.1,n=.05){Pe||(Pe=new Le);const a=Pe.createOscillator();a.frequency.value=e;const i=Pe.createGain();i.gain.value=n,i.gain.exponentialRampToValueAtTime(n/5,Pe.currentTime+t),a.connect(i),i.connect(Pe.destination),a.type="square",a.start(),a.stop(Pe.currentTime+t)}return function(){if("https:"!==location.protocol&&"file:"!==location.protocol&&"content:"!==location.protocol&&"localhost"!==location.hostname){const e="https://"+location.hostname+location.pathname;return alert("BLX-API: HTTPS required. Jump to '"+e+"'"),void window.location.assign(e)}void 0!==navigator.bluetooth||alert("BLX-API: Browser does not support Bluetooth!")}(),{setTerminal:Ne,userSendCmd:async(e,t)=>{if(await async function(e,t){const n=e.trim();Ie("=> "+n),S=0,n.startsWith(".")?await me(n.substring(1)):void 0!=t?await ce(n,t):await ce(n),await se(),S&&(Ie(S),o&&o("ERR",0,S))}(e,t),S)throw S;if(!0===k)throw new Error("*** BLX BUSY (Since "+(Date.now()-g).toFixed(0)+" msec) ***")},getDevice:()=>s,getMemory:()=>O,getPinOK:()=>y,frq_ping:ze,getCrc32:r,IparamAddChannel:function(e,t){let n,a=0,i=parseInt(e[2]);for(;;){const t=_e(e,a);if(t<0)break;if(n=t,++a>=i)return!1}let r=Fe(e);e.push("@"+a);for(let a=0;a<r-1;a++)!0===t&&void 0!==n?e.push(e[n+a+1]):e.push("");return!0},CompactIparam:function(e){let t=0,n=0;for(;;){let a=_e(e,n);if(a<0)break;parseInt(e[a+1])>0&&(t=n),n++}let a=_e(e,t)+Fe(e);e.splice(a,999)},IparamValidate:function(e){if(e.length<19)return"300: Size ";if("@100"!==e[0])return"301: File Format (ID not '@100')";if(Be(e[1],1,999999))return"302: DEVICE_TYP";if(Be(e[2],1,90))return"303: MAX_CHANNELS";if(Be(e[3],0,255))return"304: HK_FLAGS";if(10!==e[4].length)return"305: Cookie (10 Digits)";if(e[5].length>41)return"306: Device Name Len";if(Be(e[6],10,86400))return"307: Period";if(Be(e[7],0,parseInt(e[6])-1))return"308: Period Offset";if(Be(e[8],0,parseInt(e[6])))return"309: Alarm Period";if(Be(e[9],0,604799))return"310: Internet Period";if(Be(e[10],0,parseInt(e[9])))return"311: Internet Period";if(Be(e[11],-43200,43200))return"312: UTC Offset";if(Be(e[12],0,255))return"313: Record Flags";if(Be(e[13],0,255))return"314: HK Flags";if(Be(e[14],0,255))return"315: HK Reload";if(Be(e[15],0,255))return"316: Net Mode";if(Be(e[16],0,255))return"317: Error Policy";if(Be(e[17],-40,10))return"318: MinTemp oC";if(Be(e[18],0,2147483647))return"319: Config0_U31";if(e[19].length>79)return"320: Configuration Command Len";let t=_e(e,0);if(t<19)return"600: Missing #0";let n=0;for(;;){if(e.length-t<13)return"601: No of Params #"+n;if(Be(e[t+1],0,255))return"602: Action #"+n;if(Be(e[t+2],0,65535))return"603: PhysChan #"+n;if(e[t+3].length>8)return"604: KanCaps Len #"+n;if(Be(e[t+4],0,255))return"605: SrcIndex #"+n;if(e[t+5].length>8)return"606: Unit Len #"+n;if(Be(e[t+6],0,255))return"607: MemFormat #"+n;if(Be(e[t+7],0,2147483647))return"608: DB_ID #"+n;if(Me(e[t+8]))return"609: Offset #"+n;if(Me(e[t+9]))return"610: Factor #"+n;if(Me(e[t+10]))return"611: Alarm_Hi #"+n;if(Me(e[t+11]))return"612: Alarm_Low #"+n;if(Be(e[t+12],0,65535))return"613: MeasBits #"+n;if(e[t+13].length>32)return"614: XBytes Len #"+n;if(void 0===e[t+14])break;if(e[t+14]!=="@"+(n+1).toString())return"615: Unexpected Line #"+n;t+=14,n++}},SysParamValidate:function(e){return e.length<19?"200: Size ":"@200"!==e[0]?"201: File Format (ID not '@200')":e[1].length>41?"202: APN Len":e[2].length>41?"203: Server Len":e[3].length>41?"204: Script Len":e[4].length>41?"205: API Key Len":Be(e[5],0,255)?"206: ConFlags":Be(e[6],0,65535)?"207: SIM PIN":e[7].length>41?"208: User Len":e[8].length>41?"209: Password Len":Be(e[9],10,255)?"210: Max_creg":Be(e[10],1,65535)?"211: Port":Be(e[11],1e3,65535)?"212: Timeout_0":Be(e[12],1e3,65535)?"213: Timeout_run":Be(e[13],60,3600)?"214: Reload":Be(e[14],0,1e5)?"215: Bat. Capacity":Me(e[15])?"216: Bat. Volt 0%":Me(e[16])?"217: Bat. Volt 100%":Be(e[17],1e3,2e31)?"218: Max Ringsize":Be(e[18],0,1e9)?"219: mAmsec/Measure":(e.length<20&&(e[19]="0"),Be(e[19],0,255)?"220: Mobile_Protocol":void 0)}}})();"undefined"!=typeof module&&void 0!==module.exports?module.exports.blx=blx:"function"==typeof define&&define.amd?define([],function(){return blx}):window.blx=blx;